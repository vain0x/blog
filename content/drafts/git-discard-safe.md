---
title: Gitで作業中の変更を安全に破棄する
tags:
    - Git
    - Tips
    - WIP
draft: true
---

現在の作業がまるまる不要なとき、Gitを使って簡単かつ安全に破棄する方法を考えます。

## 動機

編集が不要になるというのは、例えば

- 試しに書いてみただけで保存するつもりがない、
- 作業は完了しつつあるが作りが雑なのでイチから書き直したい、
- 作ろうとしているものが完全にゴミであることに気づいてしまった、

といったときです。

## 危険な方法

よくあるのは checkout や ``reset --hard`` を使う方法ですが、これは変更がどこにも残らないので危険です。いらないコードが消えるのはいいのですが、例えばターミナルのコマンド履歴機能なのでコマンドが暴発したときのリスクが高いです。

## 安全な方法

破棄されたものも一応ゴミ箱的なところに保管したい。そして誤爆したときは簡単に戻したい。こんなときにおすすめなのが、コミットを作ってキャンセルする方法です:

```ini
[alias]
    discard = !git add . && git commit --allow-empty -m 'discard!' && git reset --hard HEAD~
```

このコマンドは、作業ツリーにあるファイルをすべてコミットしてから、1つ前のコミットのの状態に作業ツリーに戻します。一時的に作られた `'discard!'` コミットはブランチやタグから参照されていないので「不要なコミット」として扱われますが、Git は不要なコミットをしばらくは消さないので大丈夫です。

キャンセルするには、この一時コミットの状態を作業ツリーに復元します。




**WIP**: discard! を探したほうがいいかも。merge-ff + reset より merge --no-commit --no-edit のほうがいいかも。

```ini
[alias]
    discard-undo =
```




## 確実な方法

すべてスタッシュに入れてしまうとより確実ですが、スタッシュが完全にゴミ溜めになってしまうので抵抗があります。

```sh
git add . && git stash
```
